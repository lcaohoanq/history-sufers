<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History Surfers - Multiplayer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700"
      rel="stylesheet"
    />

    <!-- Colyseus Client -->
    <script src="https://unpkg.com/colyseus.js@0.15.8/dist/colyseus.js"></script>

    <!-- Three.js -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.180.0/build/three.module.js",
          "three/examples/jsm/loaders/GLTFLoader.js": "https://unpkg.com/three@0.180.0/examples/jsm/loaders/GLTFLoader.js"
        }
      }
    </script>

    <!-- Game Scripts -->
    <script type="text/javascript" src="js/audio-manager.js"></script>
    <script type="module" src="js/network-colyseus.js"></script>
    <!-- NOT using game-multiplayer.js - logic is embedded in SPA -->
    <script type="module" src="scripts/network-strategy.js"></script>
    <script type="module" src="js/object.js"></script>
    <script type="module" src="scripts/tutorial-panel.js"></script>

    <!-- Styles -->
    <link href="style.css" rel="stylesheet" />
    <link href="./styles/lobby.style.css" rel="stylesheet" />
    <link href="./styles/sound_toggle.css" rel="stylesheet" />
    <link href="./styles/stat_panel.css" rel="stylesheet" />
  </head>

  <body>
    <!-- ========================================
         LOBBY VIEW (Initial State)
         ======================================== -->
    <div id="lobbyView" class="view active">
      <!-- Animated Background Orbs -->
      <div class="orb orb1"></div>
      <div class="orb orb2"></div>
      <div class="orb orb3"></div>

      <!-- Food Pellets -->
      <div class="pellet" style="top: 15%; left: 10%; animation-delay: 0s"></div>
      <div class="pellet" style="top: 25%; right: 15%; animation-delay: 0.5s"></div>
      <div class="pellet" style="bottom: 20%; left: 20%; animation-delay: 1s"></div>
      <div class="pellet" style="top: 60%; right: 25%; animation-delay: 1.5s"></div>
      <div class="pellet" style="bottom: 30%; right: 10%; animation-delay: 2s"></div>
      <div class="pellet" style="top: 40%; left: 15%; animation-delay: 0.7s"></div>
      <div class="pellet" style="top: 70%; left: 40%; animation-delay: 1.2s"></div>
      <div class="pellet" style="bottom: 40%; right: 40%; animation-delay: 1.8s"></div>

      <!-- Main Container -->
      <div class="container">
        <!-- Mode Selection -->
        <div id="modeSelection">
          <div class="card">
            <h1 class="card-title">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h1>

            <div class="mode-grid">
              <!-- Single Player Mode -->
              <button class="mode-card" onclick="location.href='singleplayer.html'">
                <div class="mode-icon">üèÉ</div>
                <h3>Ch∆°i ƒë∆°n</h3>
                <p>Ch∆°i m·ªôt m√¨nh v√† luy·ªán t·∫≠p k·ªπ nƒÉng</p>
              </button>

              <!-- Multiplayer Mode -->
              <button class="mode-card multiplayer" onclick="showMultiplayerOptions()">
                <div class="mode-icon">üë•</div>
                <h3>Nhi·ªÅu ng∆∞·ªùi ch∆°i</h3>
                <p>Thi ƒëua v·ªõi b·∫°n b√®</p>
                <div class="badge-new">Colyseus</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Multiplayer Options -->
        <div id="multiplayerOptions" style="display: none">
          <div class="card">
            <button class="btn" onclick="backToModeSelection()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">Nhi·ªÅu ng∆∞·ªùi ch∆°i</h1>

            <div class="mode-grid">
              <div class="mode-card create" onclick="showCreateRoom()">
                <div class="mode-icon">‚ûï</div>
                <h3>T·∫°o ph√≤ng</h3>
                <p>T·∫°o ph√≤ng m·ªõi v√† m·ªùi b·∫°n b√®</p>
              </div>

              <div class="mode-card join" onclick="showJoinRoom()">
                <div class="mode-icon">üö™</div>
                <h3>Tham gia</h3>
                <p>Tham gia ph√≤ng b·∫±ng m√£</p>
              </div>

              <div class="mode-card browse" onclick="showRoomList()">
                <div class="mode-icon">üîç</div>
                <h3>T√¨m ph√≤ng</h3>
                <p>Xem c√°c ph√≤ng ƒëang ch·ªù</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Create Room -->
        <div id="createRoom" style="display: none">
          <div class="card" style="max-width: 600px; margin: 0 auto">
            <button class="btn" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">T·∫°o ph√≤ng m·ªõi</h1>

            <form onsubmit="createRoom(event)" class="form">
              <div class="form-group">
                <label for="createPlayerName">T√™n c·ªßa b·∫°n</label>
                <input
                  type="text"
                  id="createPlayerName"
                  placeholder="Nh·∫≠p t√™n..."
                  required
                  maxlength="20"
                />
              </div>

              <button type="submit" class="btn btn-primary">
                <span>T·∫°o ph√≤ng</span>
                <span>üéÆ</span>
              </button>
            </form>

            <div id="roomInfo" class="room-info" style="display: none">
              <div class="info-box">
                <div class="info-label">M√£ ph√≤ng</div>
                <div class="info-value">
                  <span id="displayRoomId">ABC123</span>
                  <button onclick="copyRoomId()" class="copy-btn">üìã</button>
                </div>
                <div class="info-hint">Chia s·∫ª m√£ n√†y v·ªõi b·∫°n b√®</div>
              </div>

              <div class="player-list">
                <h3>Ng∆∞·ªùi ch∆°i (<span id="playerCount">0</span>)</h3>
                <div id="playersList"></div>
              </div>

              <div class="ready-section">
                <label class="ready-checkbox">
                  <input type="checkbox" id="hostReady" onchange="toggleReady()" />
                  <span>T√¥i ƒë√£ s·∫µn s√†ng</span>
                </label>

                <div class="info-message" id="readyMessage">
                  ‚è≥ Ch·ªù t·∫•t c·∫£ ng∆∞·ªùi ch∆°i s·∫µn s√†ng...
                </div>

                <!-- Start Race Button (only for host) -->
                <button
                  id="startRaceBtn"
                  class="btn btn-primary"
                  onclick="startRace()"
                  style="display: none; margin-top: 20px"
                >
                  üèÅ B·∫Øt ƒë·∫ßu ch·∫°y ƒëua
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Join Room -->
        <div id="joinRoom" style="display: none">
          <div class="card" style="max-width: 600px; margin: 0 auto">
            <button class="btn" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">Tham gia ph√≤ng</h1>

            <form onsubmit="joinRoom(event)" class="form">
              <div class="form-group">
                <label for="joinPlayerName">T√™n c·ªßa b·∫°n</label>
                <input
                  type="text"
                  id="joinPlayerName"
                  placeholder="Nh·∫≠p t√™n..."
                  required
                  maxlength="20"
                />
              </div>

              <div class="form-group">
                <label for="joinRoomId">M√£ ph√≤ng</label>
                <input
                  type="text"
                  id="joinRoomId"
                  placeholder="Nh·∫≠p m√£ ph√≤ng..."
                  required
                  maxlength="10"
                  style="text-transform: uppercase"
                />
              </div>

              <button type="submit" class="btn btn-primary">
                <span>Tham gia</span>
                <span>üöÄ</span>
              </button>
            </form>
          </div>
        </div>

        <!-- Room List -->
        <div id="roomList" style="display: none">
          <div class="card" style="max-width: 600px; margin: 0 auto">
            <button class="btn" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">Ph√≤ng ƒëang ch·ªù</h1>

            <div id="roomsList" class="rooms-grid"></div>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="toast"></div>
    </div>

    <!-- ========================================
         GAME VIEW (Hidden Initially)
         ======================================== -->
    <div id="gameView" class="view">
      <!-- Sound Toggle Button -->
      <button id="sound-toggle" class="sound-toggle" title="Toggle Sound">üîä</button>

      <!-- Stats Panel (Left Side) -->
      <div class="stats-panel" id="statsPanel">
        <h3>ƒê·ªò D√ÇN CH·ª¶</h3>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>Ni·ªÅm Tin</span>
            </span>
            <span class="stat-label-right" id="trust-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="trust-container">
            <div class="stat-bar-fill stat-bar-trust" id="trust-bar" style="width: 50%"></div>
          </div>
        </div>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>C√¥ng B·∫±ng</span>
            </span>
            <span class="stat-label-right" id="justice-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="justice-container">
            <div class="stat-bar-fill stat-bar-justice" id="justice-bar" style="width: 50%"></div>
          </div>
        </div>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>ƒêo√†n K·∫øt</span>
            </span>
            <span class="stat-label-right" id="unity-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="unity-container">
            <div class="stat-bar-fill stat-bar-unity" id="unity-bar" style="width: 50%"></div>
          </div>
        </div>
      </div>

      <!-- Score Display (Top Right) -->
      <div class="score-display">
        <p id="score">0</p>
      </div>

      <!-- Game Start Panel (Center) -->
      <div class="panel" id="gamePanel">
        <div class="game-title">
          <div class="title">T·∫°m d·ª´ng</div>
        </div>

        <div class="tutorial-tabs" id="tutorialTabs">
          <button class="tab-button active" data-target="controlsSection">ƒêi·ªÅu khi·ªÉn</button>
          <button class="tab-button" data-target="pointObjectsSection">V·∫≠t ph·∫©m c·ªông ƒëi·ªÉm</button>
          <button class="tab-button" data-target="penaltyObjectsSection">V·∫≠t ph·∫©m tr·ª´ ƒëi·ªÉm</button>
        </div>

        <div class="tutorial-section active" id="controlsSection">
          <div id="controls">
            <div class="controls-column controls-direction">
              <div class="direction-grid">
                <div class="key-card key-up">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M16 4l12 20H4z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Nh·∫£y</span>
                </div>
                <div class="key-card key-left">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M4 14l20 12V2z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Tr√°i</span>
                </div>
                <div class="key-card key-down">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M16 24L4 4h24z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Tr∆∞·ª£t (Siu)</span>
                </div>
                <div class="key-card key-right">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M28 14L8 2v24z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Ph·∫£i</span>
                </div>
              </div>
            </div>

            <div class="controls-column controls-extra">
              <div class="extra-grid">
                <div class="key-card">
                  <span class="key-label">ESC</span>
                  <span class="key-desc">Quay v·ªÅ s·∫£nh</span>
                </div>
                <div class="extra-bottom">
                  <div class="key-card">
                    <span class="key-label">V</span>
                    <span class="key-desc">ƒê·ªïi g√≥c nh√¨n</span>
                  </div>
                  <div class="key-card">
                    <span class="key-label">P</span>
                    <span class="key-desc">Thay skin</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tutorial-section" id="pointObjectsSection">
          <div class="point-object-intro">
            Ghi nh·ªõ nh·ªØng v·∫≠t ph·∫©m t√≠ch c·ª±c d∆∞·ªõi ƒë√¢y ƒë·ªÉ ∆∞u ti√™n thu th·∫≠p khi l∆∞·ªõt. Thu th·∫≠p c√†ng
            nhi·ªÅu, b·∫°n c√†ng d·ªÖ v∆∞·ª£t ƒë·ªëi th·ªß.
          </div>
          <ul class="point-object-list" id="pointObjectList"></ul>
        </div>

        <div class="tutorial-section" id="penaltyObjectsSection">
          <div class="point-object-intro">
            Nh·ªØng v·∫≠t ph·∫©m nguy hi·ªÉm n√†y s·∫Ω tr·ª´ ƒëi·ªÉm ƒë√°ng k·ªÉ ‚Äì n√© tr√°nh ƒë·ªÉ kh√¥ng t·ª•t h·∫°ng.
          </div>
          <ul class="point-object-list" id="penaltyObjectList"></ul>
        </div>

        <table id="ranks"></table>
        <div class="animate-flicker" id="variable-content">B·∫•m ph√≠m b·∫•t k√¨ ƒë·ªÉ ti·∫øp t·ª•c...</div>
      </div>

      <!-- Multiplayer HUD (Bottom Right) -->
      <div class="multiplayer-hud" id="multiplayerHud" style="display: none">
        <h3>üèÅ Ch·∫∑ng ƒëua üèÅ</h3>
        <div id="playerScores"></div>
      </div>

      <!-- Race Pause Overlay -->
      <div id="pauseOverlay" class="pause-overlay">
        <div class="pause-content">
          <h2>‚è∏Ô∏è RACE PAUSED</h2>
          <p id="pauseMessage">Waiting for player to reconnect...</p>
          <div class="loading-spinner"></div>
        </div>
      </div>

      <!-- 3D World Container -->
      <div id="world"></div>
    </div>

    <!-- Toast Notification Container (Global) -->
    <div id="toast-container" class="toast toast-top toast-end z-50"></div>

    <style>
      /* View Management */
      .view {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .view.active {
        display: block;
      }

      /* Game View Specific */
      #gameView {
        background: #000;
      }

      /* Toast Styles */
      .badge-new {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .no-rooms {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 16px;
      }

      .room-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 12px;
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .room-id {
        font-weight: 700;
        font-size: 20px;
        color: #fff;
      }

      .room-players {
        color: rgba(255, 255, 255, 0.7);
      }

      .player-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 2px solid transparent;
      }

      .player-item.ready {
        border-color: rgba(76, 175, 80, 0.5);
        background: rgba(76, 175, 80, 0.1);
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 10000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.success {
        background: rgba(76, 175, 80, 0.9);
      }

      .toast.error {
        background: rgba(244, 67, 54, 0.9);
      }

      .toast.info {
        background: rgba(33, 150, 243, 0.9);
      }

      /* Pause Overlay */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .pause-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .pause-overlay.active {
        display: flex !important;
      }

      .pause-content {
        text-align: center;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
      }

      .pause-content h2 {
        font-size: 48px;
        margin-bottom: 20px;
      }

      .pause-content p {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .loading-spinner {
        margin: 20px auto;
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
    </style>

    <script>
      // ==================== GLOBAL STATE ====================
      let networkManager = null;
      let currentRoomId = null;
      let currentSessionId = null;
      let gameInitialized = false;
      let raceStarting = false;
      let playerScoresTimer = null;

      // ==================== VIEW SWITCHING ====================
      function switchView(viewId) {
        document.querySelectorAll('.view').forEach((view) => {
          view.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
        console.log(`üìÑ Switched to view: ${viewId}`);
      }

      // ==================== INITIALIZATION ====================
      window.addEventListener('load', async () => {
        console.log('üéÆ Single Page App loaded');

        // Import and initialize network manager
        const { ColyseusNetworkManager } = await import('./js/network-colyseus.js');
        networkManager = new ColyseusNetworkManager();
        window.networkManager = networkManager;

        // Connect to server
        try {
          await networkManager.connect();
          console.log('‚úÖ Connected to Colyseus server');
        } catch (error) {
          console.error('‚ùå Failed to connect:', error);
          showToast('Failed to connect to server', 'error');
          return;
        }

        // Listen for notifications
        networkManager.on('notification', (notification) => {
          showToast(notification.message, notification.type);
        });

        // Listen for countdown
        networkManager.on('raceCountdown', (data) => {
          console.log('‚è±Ô∏è Countdown:', data.countdown);
          showToast(`Starting in ${data.countdown}...`, 'info');
        });

        // üî• Listen for race start - SWITCH TO GAME VIEW instead of navigate
        networkManager.on('raceStart', () => {
          console.log('üèÅ Race starting, switching to game view...');

          // Reset race starting flag
          raceStarting = false;

          // Switch to game view
          switchView('gameView');

          // Initialize game after switching view
          setTimeout(() => {
            if (!gameInitialized) {
              window.initMultiplayerGame(); // Call game init function
            }
          }, 100);
        });

        // Listen for players updated
        networkManager.on('playerJoined', () => {
          updatePlayersList();
          updatePlayerScores();
        });

        networkManager.on('playerLeft', () => {
          updatePlayersList();
          updatePlayerScores();
        });

        networkManager.on('opponentUpdate', () => {
          updatePlayerScores();
        });

        networkManager.on('stateChanged', () => {
          updatePlayersList();
          updatePlayerScores();
        });
      });

      // ==================== LOBBY FUNCTIONS ====================
      function showMultiplayerOptions() {
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('multiplayerOptions').style.display = 'block';
      }

      function backToModeSelection() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('modeSelection').style.display = 'block';
      }

      function showCreateRoom() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('createRoom').style.display = 'block';
      }

      function showJoinRoom() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('joinRoom').style.display = 'block';
      }

      function showRoomList() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('roomList').style.display = 'block';
        refreshRoomList();
      }

      function backToMultiplayerOptions() {
        document.getElementById('createRoom').style.display = 'none';
        document.getElementById('joinRoom').style.display = 'none';
        document.getElementById('roomList').style.display = 'none';
        document.getElementById('multiplayerOptions').style.display = 'block';

        // Reset room info
        document.getElementById('roomInfo').style.display = 'none';
        document.querySelector('#createRoom form').style.display = 'block';
      }

      // Create room
      async function createRoom(event) {
        event.preventDefault();

        const playerName = document.getElementById('createPlayerName').value.trim();
        if (!playerName) {
          showToast('Please enter your name', 'error');
          return;
        }

        try {
          showToast('Creating room...', 'info');

          const { roomId, sessionId } = await networkManager.createRoom(playerName);
          currentRoomId = roomId;
          currentSessionId = sessionId;

          console.log('‚úÖ Room created:', roomId);

          // Show room info
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';

          updatePlayersList();
          updatePlayerScores();

          showToast('Room created successfully!', 'success');
        } catch (error) {
          console.error('‚ùå Failed to create room:', error);
          showToast('Failed to create room: ' + error.message, 'error');
        }
      }

      // Join room
      async function joinRoom(event) {
        event.preventDefault();

        const playerName = document.getElementById('joinPlayerName').value.trim();
        const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();

        if (!playerName || !roomId) {
          showToast('Please fill in all fields', 'error');
          return;
        }

        try {
          showToast('Joining room...', 'info');

          const result = await networkManager.joinRoom(roomId, playerName);
          currentRoomId = result.roomId;
          currentSessionId = result.sessionId;

          console.log('‚úÖ Joined room:', roomId);

          // Show room info in create room screen
          document.getElementById('joinRoom').style.display = 'none';
          document.getElementById('createRoom').style.display = 'block';
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';

          updatePlayersList();
          updatePlayerScores();

          showToast('Joined room successfully! Wait for host to start.', 'success');
        } catch (error) {
          console.error('‚ùå Failed to join room:', error);
          showToast('Failed to join room: ' + error.message, 'error');
        }
      }

      // Start race (host only)
      function startRace() {
        if (!networkManager || !networkManager.room) {
          showToast('Not in a room', 'error');
          return;
        }

        // Prevent multiple race start attempts
        if (raceStarting) {
          console.warn('‚ö†Ô∏è Race already starting...');
          return;
        }

        raceStarting = true;
        console.log('üèÅ Host requesting race start...');

        // Disable start button
        const startBtn = document.getElementById('startRaceBtn');
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.textContent = '‚è≥ Starting...';
        }

        try {
          networkManager.room.send('startRace');
        } catch (error) {
          console.error('‚ùå Failed to start race:', error);
          showToast('Failed to start race', 'error');
          raceStarting = false;
          if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = 'üèÅ B·∫Øt ƒë·∫ßu ch·∫°y ƒëua';
          }
        }
      }

      // Refresh room list
      async function refreshRoomList() {
        try {
          showToast('Loading rooms...', 'info');

          const rooms = await networkManager.listRooms();
          const roomsContainer = document.getElementById('roomsList');

          if (rooms.length === 0) {
            roomsContainer.innerHTML = '<div class="no-rooms">Kh√¥ng c√≥ ph√≤ng n√†o ƒëang ch·ªù</div>';
            return;
          }

          roomsContainer.innerHTML = rooms
            .map(
              (room) => `
          <div class="room-card">
            <div class="room-header">
              <span class="room-id">${room.roomId}</span>
              <span class="room-players">${room.clients}/${room.maxClients} üë•</span>
            </div>
            <button class="btn btn-primary" onclick="quickJoinRoom('${room.roomId}')">Tham gia</button>
          </div>
        `
            )
            .join('');

          showToast(`Found ${rooms.length} room(s)`, 'success');
        } catch (error) {
          console.error('‚ùå Failed to load rooms:', error);
          showToast('Failed to load rooms', 'error');
        }
      }

      // Quick join from room list
      async function quickJoinRoom(roomId) {
        const playerName = prompt('Nh·∫≠p t√™n c·ªßa b·∫°n:');
        if (!playerName) return;

        try {
          showToast('Joining room...', 'info');

          await networkManager.joinRoom(roomId, playerName);

          // Show room info
          document.getElementById('roomList').style.display = 'none';
          document.getElementById('createRoom').style.display = 'block';
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';

          updatePlayersList();
          updatePlayerScores();

          showToast('Joined successfully!', 'success');
        } catch (error) {
          console.error('‚ùå Failed to join room:', error);
          showToast('Failed to join room: ' + error.message, 'error');
        }
      }

      // Toggle ready status
      function toggleReady() {
        const isReady = document.getElementById('hostReady').checked;
        networkManager.setReady(isReady);
        console.log('Ready status:', isReady);
      }

      // Update players list
      function updatePlayersList() {
        if (!networkManager || !networkManager.room) return;

        const players = networkManager.getAllPlayers();
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');

        if (!playersList || !playerCount) return;

        playerCount.textContent = players.length;

        playersList.innerHTML = players
          .map(
            (player) => `
        <div class="player-item ${player.ready ? 'ready' : ''}">
          <span class="player-name">${player.name}${player.isSelf ? ' (You)' : ''}</span>
          <span class="player-status">${player.ready ? '‚úÖ S·∫µn s√†ng' : '‚è≥ Ch·ªù...'}</span>
        </div>
      `
          )
          .join('');

        // Show start button if host and all ready
        const isHost = networkManager.sessionId === networkManager.room.state.hostId;
        const allReady = players.every((p) => p.ready);
        const startBtn = document.getElementById('startRaceBtn');

        if (startBtn) {
          startBtn.style.display = isHost && allReady && players.length >= 2 ? 'block' : 'none';
        }
      }

      function updatePlayerScores() {
        const scoresContainer = document.getElementById('playerScores');
        if (!scoresContainer) return;

        if (!networkManager || !networkManager.room || !networkManager.room.state) {
          scoresContainer.innerHTML = '';
          return;
        }

        const players = networkManager.getAllPlayers().slice();

        if (players.length === 0) {
          scoresContainer.innerHTML = '<div class="player-score-empty">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i</div>';
          return;
        }

        players.sort((a, b) => {
          const scoreA = typeof a.score === 'number' ? a.score : 0;
          const scoreB = typeof b.score === 'number' ? b.score : 0;
          if (scoreB !== scoreA) return scoreB - scoreA;
          return (a.name || '').localeCompare(b.name || '');
        });

        const fragment = document.createDocumentFragment();

        players.forEach((player, index) => {
          const item = document.createElement('div');
          item.className = 'player-score-item';

          if (player.isSelf) {
            item.classList.add('self');
          }

          const nameEl = document.createElement('span');
          nameEl.className = 'player-score-name';

          const playerName = player.name || `Ng∆∞·ªùi ch∆°i ${index + 1}`;
          nameEl.textContent = `${index + 1}. ${playerName}${player.isSelf ? ' (B·∫°n)' : ''}`;

          const scoreEl = document.createElement('span');
          scoreEl.className = 'player-score-value';
          const scoreValue = typeof player.score === 'number' ? player.score : 0;
          scoreEl.textContent = scoreValue;

          item.appendChild(nameEl);
          item.appendChild(scoreEl);
          fragment.appendChild(item);
        });

        scoresContainer.innerHTML = '';
        scoresContainer.appendChild(fragment);
      }

      function startPlayerScoreUpdates() {
        if (playerScoresTimer) return;
        updatePlayerScores();
        playerScoresTimer = setInterval(updatePlayerScores, 750);
      }

      function stopPlayerScoreUpdates() {
        if (playerScoresTimer) {
          clearInterval(playerScoresTimer);
          playerScoresTimer = null;
        }

        const scoresContainer = document.getElementById('playerScores');
        if (scoresContainer) {
          scoresContainer.innerHTML = '';
        }
      }

      // Copy room ID to clipboard
      function copyRoomId() {
        const roomId = document.getElementById('displayRoomId').textContent;
        navigator.clipboard.writeText(roomId).then(
          () => showToast('Room ID copied!', 'success'),
          () => showToast('Failed to copy', 'error')
        );
      }

      // Toast notification
      function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;

        setTimeout(() => {
          toast.className = 'toast';
        }, 3000);
      }

      // ==================== GAME INITIALIZATION ====================
      window.initMultiplayerGame = async function () {
        console.log('üéÆ Initializing multiplayer game...');

        if (gameInitialized) {
          console.warn('‚ö†Ô∏è Game already initialized');
          return;
        }

        if (window.currentWorld) {
          console.warn('‚ö†Ô∏è World already exists');
          return;
        }

        try {
          gameInitialized = true;

          // Import required modules
          const { WorldMap } = await import('./scripts/maps.js');
          const { MultiplayerStrategy } = await import('./scripts/network-strategy.js');

          // Hide game panel if exists
          const panel = document.getElementById('gamePanel');
          if (panel) panel.style.display = 'none';

          // Create multiplayer strategy
          const networkStrategy = new MultiplayerStrategy(networkManager);

          // Create world with multiplayer strategy
          const world = new WorldMap(networkStrategy);
          window.currentWorld = world;

          console.log('‚úÖ Multiplayer game started');

          // Show multiplayer HUD
          const multiplayerHud = document.getElementById('multiplayerHud');
          if (multiplayerHud) {
            multiplayerHud.style.display = 'block';
          }

          startPlayerScoreUpdates();

          // Handle audio transition (intro -> loop)
          if (typeof AudioManager !== 'undefined') {
            const activeAudio = AudioManager._active();
            if (!activeAudio.loop) {
              // Intro is playing, transition to loop
              console.log('üéµ Transitioning from intro to loop...');
              AudioManager.play(); // This crossfades intro -> loop
            } else {
              console.log('üéµ Loop already playing');
            }
          }
        } catch (error) {
          console.error('‚ùå Failed to initialize game:', error);
          showToast('Failed to start game', 'error');
          gameInitialized = false;
        }
      };

      // ==================== GAME RETURN TO LOBBY ====================
      window.returnToLobby = function () {
        console.log('üîô Returning to lobby...');

        // Cleanup game
        if (window.currentWorld && typeof window.currentWorld.cleanup === 'function') {
          window.currentWorld.cleanup();
          window.currentWorld = null;
        }

        // Stop audio
        if (typeof AudioManager !== 'undefined') {
          AudioManager.stop();
        }

        // Reset game state
        gameInitialized = false;

        stopPlayerScoreUpdates();

        // Switch back to lobby view
        switchView('lobbyView');

        // Reset lobby to multiplayer options
        backToMultiplayerOptions();
        backToModeSelection();
      };
    </script>
  </body>
</html>
